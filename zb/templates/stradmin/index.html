{% extends 'admin/master.html' %}

{% block head_css %}
{{ super() }}
<link href="{{ admin_static.url(filename='vendor/bootstrap-daterangepicker/daterangepicker-bs3.css', v='3.x') }}" rel="stylesheet">
{% endblock %}

{% block body %}
{{ super() }}

        {% if not current_user.is_authenticated %}
        <div class="container">
            <div class="row">
                <div class="col-sm-10 col-sm-offset-1">
                    <h1>CK 管理后台</h1>
                    <p class="lead">
                        Authentication
                    </p>
                    <p>You can register as a regular user, or log in as a superuser
                    <p>
                        <a class="btn btn-primary" href="{{ url_for('security.login') }}">login</a> <a class="btn btn-default" href="{{ url_for('security.register') }}">register</a>
                    </p>
                </div>
            </div>
        </div>

        {% else %}
        <div class="container">
            <div class="row">

                <div class="col-lg-3 col-xs-6">
                    <small>
                        <li>DB中共有 {{ g_stat['total'] }} 个CK &nbsp; DB中可使用 {{ g_stat['could_use'] }} 个CK</li>
                        <li>DB中有 {{ g_stat['uneffective'] }} 个无效CK</li>
                        <li>缓存中未用 {{ g_stat['unused'] }} 个CK </li>
                        <li>总计可使用 {{ g_stat['unused'] + g_stat['could_use'] }} 个CK </li>
                        <li>检查成功请求： {{ g_stat['check_req'] }},&nbsp 失败请求：{{ g_stat['check_req_fail'] }} </li>
                        </br>
                        <li>启动时间：{{ g_stat['boot_ts'] }} </li>
                    </small>
                </div>

                <div class="col-md-4">
                    <form action="/admin/download" enctype='multipart/form-data' method='POST'>
                        <div class="row">
                            <div class="col-md-3">
                                <input class="btn btn-primary btn-sm" type="submit" value="下载CK">
                            </div>
                            <div class="input-group input-group-sm mb-3">
                                <input  id="reportrange" class="form-control" type="text" name="date_range" size="25" />
                            </div>
                        </div>
                    </form>
                    <br>
                    <form class="form-inline" action="/admin/download" enctype='multipart/form-data' method='POST'>
                        <div class="row">
                            <div class="col-md-3">
                                <button type="submit" class="btn btn-primary btn-sm">下载CK</button>
                            </div>
                            <div class="input-group input-group-sm mb-3">
                                <input type="text" class="form-control" placeholder="ID Index Begin" value="0" name="ck_from" size="5" />
                            </div>
                            <div class="input-group input-group-sm mb-3">
                                <input type="text" class="form-control" placeholder="Num" value="1000" name="ck_to" size="5" />
                            </div>

                        </div>
                    </form>
                </div>

                <div class="col-lg-5 col-xs-6">
                    <form action="/admin/upload" class="admin-form form-horizontal" enctype='multipart/form-data' method='POST'>
                        <div class="form-group">
                            <label for="group" class="col-md-2 control-label">CK标签
                                &nbsp;
                            </label>
                            <div class="col-md-2">
                              <input class="form-control" id="group" name="group" type="text"  value="G0">
                            </div>
                          </div>

                        <div class="form-group">
                            <label for="alipayurl" class="col-md-2 control-label">CK文件
                                &nbsp;
                            </label>
                            <div class="col-md-2">
                                <input  class="custom-file-input form-control-sm" name="file" size="5" type="file" />
                            </div>
                        </div>

                        <div class="form-group">
                            <div class="col-md-offset-2 col-md-10 submit-row">
                              <input type="submit" class="btn btn-primary" value="提交" />
                            </div>
                        </div>

                    </form>
                </div>

            </div>
            <hr>

            <div class="row">
                <div class="col-lg-5 col-xs-6">
                    <small>DB中CK统计</small>
                    <table class="table table-striped table-dark">
                      <thead>
                        <tr>
                          <th scope="col">组名</th>
                          <th scope="col">总数</th>
                          <th scope="col">有效</th>
                          <th scope="col">无效</th>
                          <th scope="col">可用</th>
                        </tr>
                      </thead>
                      <tbody>
                      {% for record in db_stats %}
                        <tr>
                          <td>{{ record['grp'] }}</td>
                          <td>{{ record['total'] }}</td>
                          <td>{{ record['effective_num'] }}</td>
                          <td>{{ record['uneffective_num'] }}</td>
                          <td>{{ record['could_use'] }}</td>
                        </tr>
                      {% endfor %}
                      </tbody>
                    </table>
                </div>

                <div class="col-lg-5 col-xs-6">
                    <small>缓存中CK统计</small>
                    <table class="table table-striped table-dark">
                      <thead>
                        <tr>
                          <th scope="col">组名</th>
                          <th scope="col">数量</th>
                        </tr>
                      </thead>
                      <tbody>
                      {% for record in rd_stats %}
                        <tr>
                          <td>{{ record['grp'] }}</td>
                          <td>{{ record['num'] }}</td>
                        </tr>
                      {% endfor %}
                      </tbody>
                    </table>
                </div>

            </div>

        </div>
        {% endif %}

{% block tail %}
    <script src="{{ admin_static.url(filename='vendor/bootstrap-daterangepicker/daterangepicker.js', v='1.3.22') }}" type="text/javascript"></script>
    <script type="text/javascript">
        $(function() {
            var start = moment().subtract(29, 'days');
            var end = moment();

            function cb(start, end) {
                var psel = document.getElementById("reportrange");
                psel.value=start.format('MM/DD/YYYY') + ' - ' + end.format('MM/DD/YYYY')
            }

            $('#reportrange').daterangepicker({
                startDate: start,
                endDate: end,
                ranges: {
                   'Today': [moment(), moment()],
                   'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                   'Last 7 Days': [moment().subtract(6, 'days'), moment()],
                   'Last 30 Days': [moment().subtract(29, 'days'), moment()],
                   'This Month': [moment().startOf('month'), moment().endOf('month')],
                   'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
                }
            }, cb);
            cb(start, end);
        });
    </script>
{% endblock %}

{% endblock body %}
